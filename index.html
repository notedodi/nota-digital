<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <!-- Viewport setting optimal untuk mobile web app -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generator Nota Digital</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS Reset & Variables */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #d1d5db;
            --radius: 8px;
        }

        html,
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-size: 14px;
            line-height: 1.5;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 16px;
            width: 100%;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-main);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            min-height: 44px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
            background-color: #fff;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Item Card Layout & Collapse Styles */
        .items-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .item-card {
            background: #f9fafb;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            position: relative;
            transition: all 0.2s ease;
        }

        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
            /* Tambahan area sentuh yang lebih nyaman */
            padding: 4px 0;
        }

        .item-card-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .item-card-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chevron {
            display: inline-flex;
            transition: transform 0.3s ease;
            color: var(--text-muted);
        }

        .chevron.collapsed {
            transform: rotate(-90deg);
        }

        .header-summary-total {
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: 600;
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .item-card-body {
            margin-top: 0;
            padding-top: 0;
            border-top: 1px dashed var(--border);
            overflow: hidden;
            transition: max-height 0.35s ease, margin-top 0.35s ease, padding-top 0.35s ease, opacity 0.25s ease;
            opacity: 1;
        }

        .item-card-body.collapsed {
            max-height: 0 !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
            border-top: none;
            opacity: 0;
        }

        .item-card-body.expanded {
            margin-top: 16px;
            padding-top: 16px;
            opacity: 1;
        }

        /* Confirm Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: #fff;
            border-radius: 12px;
            padding: 28px 24px;
            max-width: 340px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            animation: scaleIn 0.2s ease;
        }

        .modal-box p {
            font-size: 1rem;
            font-weight: 500;
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .modal-box .modal-sub {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            min-height: 42px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: inherit;
            transition: transform 0.15s;
        }

        .modal-actions button:active {
            transform: scale(0.97);
        }

        .modal-btn-cancel {
            background: #f3f4f6;
            color: var(--text-main);
        }

        .modal-btn-danger {
            background: var(--danger);
            color: #fff;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1f2937;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .item-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .item-total-text {
            margin-top: 12px;
            text-align: right;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-main);
            padding-top: 12px;
            border-top: 1px dashed var(--border);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 44px;
            padding: 10px 16px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px dashed var(--text-muted);
            color: var(--text-main);
        }

        .btn-danger-sm {
            background-color: #fee2e2;
            color: var(--danger);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            min-height: 32px;
            cursor: pointer;
        }

        .grand-total-form {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: right;
            padding: 16px 0;
            margin-top: 8px;
            border-top: 2px solid var(--border);
        }

        /* Receipt Preview Area */
        .receipt-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            background: var(--bg-color);
            padding: 10px 0;
            overflow: hidden;
        }

        .receipt-card {
            background-color: #ffffff;
            width: 100%;
            max-width: 520px;
            padding: 24px;
            color: #000;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px dashed #000;
            padding-bottom: 16px;
        }

        .receipt-shop {
            font-size: 1.25rem;
            font-weight: 700;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
            margin-bottom: 4px;
        }

        .receipt-title {
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .receipt-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .receipt-table th {
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 8px 0;
            text-align: left;
        }

        .receipt-table td {
            padding: 8px 0;
            vertical-align: top;
        }

        .col-qty {
            width: 10%;
            text-align: center !important;
        }

        .col-price {
            width: 22%;
            text-align: right !important;
        }

        .col-total {
            width: 25%;
            text-align: right !important;
        }

        .receipt-summary {
            border-top: 1px dashed #000;
            padding-top: 12px;
            margin-bottom: 24px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1rem;
        }

        .receipt-footer {
            text-align: center;
            font-size: 0.75rem;
            border-top: 1px dashed #000;
            padding-top: 16px;
            color: #333;
        }

        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                align-items: flex-start;
                padding: 24px;
            }

            .panel {
                padding: 24px;
            }

            .form-row {
                flex-direction: row;
            }

            .form-row .form-group {
                flex: 1;
            }

            .panel-editor {
                flex: 1.2;
            }

            .panel-preview {
                flex: 1;
                position: sticky;
                top: 24px;
            }

            .btn {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <p>Hapus Barang?</p>
            <div class="modal-sub" id="confirmModalText">Yakin ingin menghapus barang ini?</div>
            <div class="modal-actions">
                <button class="modal-btn-cancel" onclick="closeConfirmModal()">Batal</button>
                <button class="modal-btn-danger" id="confirmDeleteBtn">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <div id="loading">
        <div class="spinner"></div>
        <div>Memproses Nota...</div>
    </div>

    <div class="container">
        <!-- PANEL EDITOR -->
        <div class="panel panel-editor">
            <div class="panel-title">Informasi Nota</div>

            <div class="form-group">
                <label for="shopName">Nama Usaha / Toko</label>
                <input type="text" id="shopName" class="form-control" value="CATATAN PENGELUARAN"
                    oninput="updatePreview()">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="receiptNo">Orderan</label>
                    <input type="text" id="receiptNo" class="form-control" value="dr. " oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label for="receiptDate">Tanggal</label>
                    <input type="date" id="receiptDate" class="form-control" onchange="updatePreview()">
                </div>
            </div>

            <div class="panel-title" style="margin-top: 16px;">Daftar Barang</div>

            <div id="itemsContainer" class="items-container">
                <!-- Dirender via JS -->
            </div>

            <button class="btn btn-outline" onclick="addItem()">+ Tambah Barang</button>

            <div class="grand-total-form" id="formTotal">
                Total: Rp 0
            </div>
        </div>

        <!-- PANEL PREVIEW -->
        <div class="panel panel-preview">
            <div class="panel-title">Preview Nota</div>

            <div class="receipt-wrapper">
                <div class="receipt-card" id="receiptCanvas">
                    <div class="receipt-header">
                        <div class="receipt-shop" id="prevShopName">CATATAN PENGELUARAN</div>
                        <div class="receipt-title">KANG DODI</div>
                    </div>

                    <div class="receipt-info">
                        <div>Orderan: <span id="prevReceiptNo">dr. </span></div>
                        <div id="prevDate">-</div>
                    </div>

                    <table class="receipt-table">
                        <thead>
                            <tr>
                                <th>Rincian</th>
                                <th class="col-qty">Qty</th>
                                <th class="col-price">Harga</th>
                                <th class="col-total">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody id="prevItemsBody">
                            <!-- Dirender via JS -->
                        </tbody>
                    </table>

                    <div class="receipt-summary">
                        <div class="summary-row">
                            <span>TOTAL</span>
                            <span id="prevGrandTotal">Rp 0</span>
                        </div>
                    </div>

                    <div class="receipt-footer">
                        Terima Kasih
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadReceipt()" style="margin-top: 24px;">
                Download Nota (JPG)
            </button>
        </div>
    </div>

    <script>
        document.getElementById('receiptDate').valueAsDate = new Date();

        // Ditambahkan state isExpanded (default true untuk barang pertama)
        let items = [
            { id: Date.now(), name: '', qty: 1, price: 0, isExpanded: true }
        ];

        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency', currency: 'IDR',
                minimumFractionDigits: 0, maximumFractionDigits: 0
            }).format(number);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        };

        function addItem() {
            // Tutup semua form barang yang lain agar layar tidak terlalu panjang
            items.forEach(item => item.isExpanded = false);

            // Tambahkan barang baru dalam posisi terbuka (expanded)
            items.push({ id: Date.now(), name: '', qty: 1, price: 0, isExpanded: true });

            renderEditor();
            updatePreview();
        }

        function removeItem(id, event) {
            // Mencegah trigger event toggleCollapse dari div parent-nya
            if (event) event.stopPropagation();

            if (items.length === 1) {
                showToast('Minimal harus ada satu barang!');
                return;
            }

            const item = items.find(i => i.id === id);
            const itemName = item && item.name.trim() ? item.name : 'barang ini';
            showConfirmModal(itemName, () => {
                items = items.filter(i => i.id !== id);
                renderEditor();
                updatePreview();
                showToast('Barang berhasil dihapus');
            });
        }

        function toggleCollapse(id) {
            const index = items.findIndex(item => item.id === id);
            if (index < 0) return;

            const body = document.querySelector(`#item-body-${id}`);
            if (!body) return;

            const isExpanded = items[index].isExpanded;

            if (isExpanded) {
                // Collapse: set max-height to current, then transition to 0
                body.style.maxHeight = body.scrollHeight + 'px';
                requestAnimationFrame(() => {
                    body.classList.remove('expanded');
                    body.classList.add('collapsed');
                    body.style.maxHeight = '0px';
                });
            } else {
                // Expand: remove collapsed, animate to scrollHeight
                body.classList.remove('collapsed');
                body.classList.add('expanded');
                body.style.maxHeight = body.scrollHeight + 'px';
                // After transition, remove fixed max-height
                body.addEventListener('transitionend', function handler() {
                    body.style.maxHeight = 'none';
                    body.removeEventListener('transitionend', handler);
                });
            }

            items[index].isExpanded = !isExpanded;

            // Update header badge
            const itemTotal = items[index].qty * items[index].price;
            const headerRight = document.querySelector(`#header-right-${id}`);
            const existingBadge = document.getElementById(`header-total-${id}`);
            if (!isExpanded && existingBadge) {
                // Expanding: remove badge
                existingBadge.remove();
            } else if (isExpanded && itemTotal > 0 && headerRight) {
                // Collapsing: add badge
                const badge = document.createElement('span');
                badge.className = 'header-summary-total';
                badge.id = `header-total-${id}`;
                badge.textContent = formatRupiah(itemTotal);
                headerRight.insertBefore(badge, headerRight.firstChild);
            }

            // Update chevron
            const chevron = document.querySelector(`#chevron-${id}`);
            if (chevron) {
                chevron.classList.toggle('collapsed', isExpanded);
            }
        }

        function handleInput(id, field, value) {
            const index = items.findIndex(item => item.id === id);
            if (index > -1) {
                if (field === 'qty' || field === 'price') {
                    let num = Number(value) || 0;
                    if (num < 0) num = 0; // Validasi: tidak boleh negatif
                    items[index][field] = num;
                    const rowTotal = items[index].qty * items[index].price;
                    document.getElementById(`total-${id}`).textContent = formatRupiah(rowTotal);

                    // Update juga angka total kecil di header jika form tertutup (jaga-jaga)
                    const headerTotal = document.getElementById(`header-total-${id}`);
                    if (headerTotal) headerTotal.textContent = formatRupiah(rowTotal);
                } else {
                    items[index][field] = value;
                    // Update judul header secara live
                    const headerTitle = document.getElementById(`header-title-${id}`);
                    if (headerTitle) headerTitle.textContent = value || `Barang #${index + 1}`;
                }
                updatePreview();
            }
        }

        function renderEditor() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const itemTotal = item.qty * item.price;
                const isExpanded = item.isExpanded;

                // Set text untuk header title (jika nama kosong, tampilkan Barang #X)
                const displayTitle = item.name.trim() !== '' ? item.name : `Barang #${index + 1}`;

                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <!-- Header Card: Bisa diklik untuk Toggle Collapse -->
                    <div class="item-card-header" onclick="toggleCollapse(${item.id})">
                        <div class="item-card-header-left">
                            <span class="chevron ${isExpanded ? '' : 'collapsed'}" id="chevron-${item.id}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </span>
                            <span id="header-title-${item.id}" style="color: ${item.name ? 'var(--text-main)' : 'var(--primary)'}">${displayTitle}</span>
                        </div>
                        <div class="item-card-header-right" id="header-right-${item.id}">
                            <!-- Hanya tampilkan badge harga saat card di-collapse -->
                            ${!isExpanded && itemTotal > 0 ? `<span class="header-summary-total" id="header-total-${item.id}">${formatRupiah(itemTotal)}</span>` : ''}
                            <button class="btn-danger-sm" onclick="removeItem(${item.id}, event)">Hapus</button>
                        </div>
                    </div>
                    
                    <!-- Body Card: Animasi smooth -->
                    <div class="item-card-body ${isExpanded ? 'expanded' : 'collapsed'}" id="item-body-${item.id}" style="max-height: ${isExpanded ? 'none' : '0px'}">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Nama Barang (Cth: Doubletip)" 
                                   value="${item.name}" oninput="handleInput(${item.id}, 'name', this.value)">
                        </div>
                        <div class="item-grid">
                            <div class="form-group" style="margin:0;">
                                <label>Qty</label>
                                <input type="number" class="form-control" min="1" value="${item.qty}" 
                                       oninput="handleInput(${item.id}, 'qty', this.value)">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>Harga Satuan</label>
                                <input type="number" class="form-control" min="0" value="${item.price}" 
                                       oninput="handleInput(${item.id}, 'price', this.value)">
                            </div>
                        </div>
                        <div class="item-total-text">
                            Jumlah: <span id="total-${item.id}">${formatRupiah(itemTotal)}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updatePreview() {
            document.getElementById('prevShopName').textContent = document.getElementById('shopName').value || '-';
            document.getElementById('prevReceiptNo').textContent = document.getElementById('receiptNo').value || '-';
            document.getElementById('prevDate').textContent = formatDate(document.getElementById('receiptDate').value);

            const tbody = document.getElementById('prevItemsBody');
            tbody.innerHTML = '';

            let grandTotal = 0;

            items.forEach((item) => {
                if (item.name.trim() !== '' || item.price > 0) {
                    const itemTotal = item.qty * item.price;
                    grandTotal += itemTotal;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.name || '-'}</td>
                        <td class="col-qty">${item.qty}</td>
                        <td class="col-price">${formatRupiah(item.price).replace('Rp', '').trim()}</td>
                        <td class="col-total">${formatRupiah(itemTotal).replace('Rp', '').trim()}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            const formattedTotal = formatRupiah(grandTotal);
            document.getElementById('prevGrandTotal').textContent = formattedTotal;
            document.getElementById('formTotal').textContent = `Total: ${formattedTotal}`;
        }

        // === Modal & Toast Helpers ===
        let pendingDeleteCallback = null;

        function showConfirmModal(itemName, onConfirm) {
            document.getElementById('confirmModalText').textContent = `Yakin ingin menghapus "${itemName}"?`;
            document.getElementById('confirmModal').classList.add('active');
            pendingDeleteCallback = onConfirm;
            document.getElementById('confirmDeleteBtn').onclick = () => {
                const cb = pendingDeleteCallback;
                closeConfirmModal();
                if (cb) cb();
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingDeleteCallback = null;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // === Download with Validation ===
        function downloadReceipt() {
            // Validasi: cek apakah ada barang tanpa nama
            const emptyItems = items.filter(item => item.name.trim() === '' && (item.qty > 0 || item.price > 0));
            if (emptyItems.length > 0) {
                showToast('⚠️ Ada barang yang belum diisi namanya!');
                return;
            }

            // Validasi: cek apakah ada item valid
            const validItems = items.filter(item => item.name.trim() !== '' && item.price > 0);
            if (validItems.length === 0) {
                showToast('⚠️ Tambahkan minimal 1 barang dengan nama dan harga!');
                return;
            }

            const loading = document.getElementById('loading');
            const originalElement = document.getElementById('receiptCanvas');

            loading.style.display = 'flex';

            setTimeout(() => {
                const clone = originalElement.cloneNode(true);
                clone.style.width = '520px';
                clone.style.maxWidth = 'none';
                clone.style.position = 'absolute';
                clone.style.top = '-9999px';
                clone.style.left = '-9999px';
                document.body.appendChild(clone);

                html2canvas(clone, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);

                    const link = document.createElement('a');
                    const receiptNo = document.getElementById('receiptNo').value || 'Nota';
                    link.download = `Nota_${receiptNo}.jpg`;
                    link.href = imgData;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    document.body.removeChild(clone);
                    loading.style.display = 'none';
                    showToast('✅ Nota berhasil didownload!');
                }).catch(err => {
                    console.error("Error:", err);
                    showToast('❌ Terjadi kesalahan saat membuat nota.');
                    if (document.body.contains(clone)) document.body.removeChild(clone);
                    loading.style.display = 'none';
                });
            }, 300);
        }

        renderEditor();
        updatePreview();

    </script>
</body>

</html>